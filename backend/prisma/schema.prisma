// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//yarn prisma migrate dev
model Admin {
  id                      String    @id @default(uuid())
  name                    String
  username                String
  password                String
  role                    String
  email                   String?
  reset_password_token    String?
  reset_password_expires  DateTime?
  store_id                String?
  created_at              DateTime? @default(now())
  updated_at              DateTime? @default(now())

  created_orders Order[] @relation("createdBy")
  updated_orders Order[] @relation("updatedBy")
  store          Store?  @relation(fields: [store_id], references: [id])

  @@map("admins")
}

model Client {
  id String @id @default(uuid())
  first_name String
  last_name String
  phone_number String
  addresses Address[]
  orders Order[]
  created_at DateTime? @default(now())
  updated_at DateTime? @default(now())

  @@map("clients")
}

model Address {
  id          String    @id @default(uuid())
  client_id   String
  street      String
  street_number String
  complement  String?
  neighborhood String
  reference_point String?
  city        String
  state       String
  postal_code String?
  country     String
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  client      Client    @relation(fields: [client_id], references: [id])
  orders      Order[]   // Relacionamento com os pedidos

  @@map("addresses")
}

model Product {
  id                 String   @id @default(uuid())
  name               String
  price              Float
  unity              String
  stock              Float
  enabled            Boolean
  visible_in_store   Boolean  @default(false)
  description        String?
  image              String?
  image_2            String?
  image_3            String?
  qr_code            String?
  sales_count        Int      @default(0)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  categories         ProductCategory[]

  orderItems OrderItem[]
  stockTransactions StockTransaction[]
  storeProducts    StoreProduct[]

  @@map("products")
}

model Category {
  id        String @id @default(uuid())
  name      String
  slug      String @unique
  image     String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  products  ProductCategory[]

  @@map("categories")
}

model ProductCategory {
  id          String   @id @default(uuid())
  product_id  String
  category_id String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product  Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([product_id, category_id])
  @@map("product_categories")
}

model Supplier {
  id          String   @id @default(uuid())
  name        String
  store_id    String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  store       Store?    @relation(fields: [store_id], references: [id])
  stockTransactions StockTransaction[]

  @@unique([name, store_id])
  @@map("suppliers")
}

model StoreProduct {
  id         String  @id @default(uuid())
  store_id   String
  product_id String

  price      Float
  stock      Float
  enabled    Boolean @default(true)
  visible_for_online_store    Boolean @default(false)
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt @default(now())

  store      Store   @relation(fields: [store_id], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  @@unique([store_id, product_id])
  @@map("store_products")
}

model OrderItem {
  id        String   @id @default(uuid())
  order_id  String
  product_id String?
  store_product_id String?
  store_id  String?
  quantity  Int
  price     Float

  storeProduct StoreProduct? @relation(fields: [store_product_id], references: [id])
  order     Order   @relation(fields: [order_id], references: [id])
  product   Product? @relation(fields: [product_id], references: [id])
  store     Store?   @relation(fields: [store_id], references: [id])

  @@map("order_items")
}


model Order {
  id                String        @id @default(uuid())
  code              Int           @default(autoincrement())
  store_id          String?
  description       String
  additional_information String?
  client_id         String
  client_address_id String
  pickup_on_store Boolean    @default(false)
  receiver_name     String?
  receiver_phone    String?
  products_value    Float
  delivery_fee      Float
  discount          Float        @default(0)
  total             Float
  payment_method    String?
  payment_received  Boolean      @default(false)
  delivery_date     DateTime     @default(now())
  created_by        String?
  updated_by        String?
  status            String        @default("Opened")
  has_card          Boolean       @default(false)
  card_message      String?
  card_from         String?
  card_to           String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  store             Store?         @relation(fields: [store_id], references: [id])
  client            Client        @relation(fields: [client_id], references: [id])
  clientAddress     Address @relation(fields: [client_address_id], references: [id])

  createdBy         Admin?         @relation("createdBy", fields: [created_by], references: [id])
  updatedBy         Admin?         @relation("updatedBy", fields: [updated_by], references: [id])
  online_order      Boolean       @default(false)
  store_front_order Boolean       @default(false)
  online_code       String?
  type_of_delivery  String?
  is_delivery       Boolean       @default(true)

  orderItems OrderItem[]
  ordersToReceive OrderToReceive[]
  orderDeliveries OrderDelivery[]

  @@map("orders")
}

model StockTransaction {
  id             String   @id @default(uuid())
  product_id     String
  store_id       String?
  supplier       String   // Nome do fornecedor (deprecated - usar supplier_id)
  supplier_id    String?
  unity          String   // Unidade (ex.: UN, KG, Caixa)
  quantity       Float
  unity_price    Float
  total_price    Float
  purchased_date DateTime @default(now())
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  product        Product  @relation(fields: [product_id], references: [id])
  store          Store?    @relation(fields: [store_id], references: [id])
  supplierRelation Supplier? @relation(fields: [supplier_id], references: [id])

  @@map("stock_transactions")
}

model OrderToReceive {
  id               String   @id @default(uuid())
  order_id         String
  store_id         String?
  payment_due_date DateTime
  received_date    DateTime?
  type             String
  is_archived      Boolean  @default(false)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  order            Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  store            Store?    @relation(fields: [store_id], references: [id])

  @@map("orders_to_receive")
}

model DeliveryMan {
  id           String   @id @default(uuid())
  name         String
  phone_number String
  store_id     String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  store        Store?    @relation(fields: [store_id], references: [id])
  orderDeliveries OrderDelivery[]

  @@map("delivery_men")
}

model OrderDelivery {
  id              String    @id @default(uuid())
  order_id        String
  delivery_man_id String
  store_id        String?
  delivery_date   DateTime
  is_paid         Boolean   @default(false)
  is_archived     Boolean   @default(false)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  order           Order     @relation(fields: [order_id], references: [id], onDelete: Cascade)
  deliveryMan     DeliveryMan @relation(fields: [delivery_man_id], references: [id], onDelete: Cascade)
  store           Store?     @relation(fields: [store_id], references: [id])

  @@map("order_deliveries")
}

model Store {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  cnpj             String?  @unique
  phone_number     String
  email            String   @unique
  description      String?
  
  // Redes sociais
  facebook         String?
  instagram        String?
  youtube          String?
  
  // Credenciais Mercado Pago
  mp_access_token  String?
  mp_public_key    String?
  mp_seller_id     String?
  mp_webhook_secret String?
  
  // Credenciais Banco Inter
  inter_client_id     String?
  inter_client_secret String?
  inter_api_cert_path String?
  inter_api_key_path  String?

  // Score google
  google_rating_value Float?
  google_rating_count Int?
  google_rating_url   String?
  
  // Configurações
  payment_enabled  Boolean  @default(false)
  is_active        Boolean  @default(true)
  is_first_access  Boolean  @default(true)
  logo             String?
  banner           String?
  banner_2         String?
  banner_3         String?
  
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  
  // Relacionamentos
  addresses        StoreAddress[]
  schedules        StoreSchedule[]
  holidays         StoreHoliday[]
  admins           Admin[]
  orders           Order[]
  orderItems       OrderItem[]
  ordersToReceive  OrderToReceive[]
  orderDeliveries  OrderDelivery[]
  suppliers        Supplier[]
  stockTransactions StockTransaction[]
  deliveryMen      DeliveryMan[]
  storeProducts    StoreProduct[]

  @@map("stores")
}

model StoreAddress {
  id              String   @id @default(uuid())
  store_id        String
  street          String
  street_number   String
  complement      String?
  neighborhood    String
  reference_point String?
  city            String
  state           String
  postal_code     String?
  country         String   @default("Brasil")
  is_main         Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  store           Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)
  
  @@map("store_addresses")
}

model StoreSchedule {
  id                String   @id @default(uuid())
  store_id          String
  day_of_week       String   // "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"
  is_closed         Boolean  @default(false)
  opening_time      String?  // Formato: "HH:MM"
  closing_time      String?  // Formato: "HH:MM"
  lunch_break_start String?  // Formato: "HH:MM" (opcional)
  lunch_break_end   String?  // Formato: "HH:MM" (opcional)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  store             Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)
  
  @@unique([store_id, day_of_week])
  @@map("store_schedules")
}

model StoreHoliday {
  id          String   @id @default(uuid())
  store_id    String
  date        DateTime
  name        String
  description String?
  is_closed   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  store       Store    @relation(fields: [store_id], references: [id], onDelete: Cascade)
  
  @@unique([store_id, date])
  @@map("store_holidays")
}
